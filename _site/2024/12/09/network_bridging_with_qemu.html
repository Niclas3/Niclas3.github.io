<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1" />


	<title>qemuä¸Šç½‘æŒ‡å— Â· æœå››æš®ä¸‰</title>


<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:title" content="qemuä¸Šç½‘æŒ‡å—" />
<meta name="twitter:description" content="å¦‚ä½•ä½¿ç”¨bridgeè¿æ¥qemuè™šæ‹Ÿæœºå’Œå®¿ä¸»æœº">

<meta name="description" content="å¦‚ä½•ä½¿ç”¨bridgeè¿æ¥qemuè™šæ‹Ÿæœºå’Œå®¿ä¸»æœº">



<link rel="icon" href="http://localhost:4000/assets/favicon.png">
<link rel="apple-touch-icon" href="http://localhost:4000/assets/touch-icon.png">
<link rel="stylesheet" href="http://localhost:4000/assets/core.css">
<link rel="canonical" href="http://localhost:4000/2024/12/09/network_bridging_with_qemu.html">
<link rel="alternate" type="application/atom+xml" title="æœå››æš®ä¸‰" href="http://localhost:4000/feed.xml" />





	</head>

	<body>
                <a href="/about">About</a>
		<aside class="logo">

	

	<a href="/">
            <img src="/assets/headImg.png" class="gravatar">
	</a>
	<span class="logo-prompt">Back to Home</span>

</aside>


		<main>
			<article>

	<div class="center">
		<h1>qemuä¸Šç½‘æŒ‡å—</h1>
		<time>December 9, 2024</time>
	</div>

	<div class="divider"></div>

	<h1 id="å¦‚ä½•ä½¿ç”¨bridgeè¿æ¥qemuè™šæ‹Ÿæœºå’Œå®¿ä¸»æœº">å¦‚ä½•ä½¿ç”¨bridgeè¿æ¥qemuè™šæ‹Ÿæœºå’Œå®¿ä¸»æœº</h1>

<h2 id="requirements">Requirements</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#æœ¬æœºç¯å¢ƒ
uname -a
Linux k 6.2.0-37-generic #38.22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Thu Nov 2 18:01:13 UTC 2 x86_64 x86_64 x86_64 GNU/Linux
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> # å®‰è£…è™šæ‹Ÿç½‘æ¡¥å·¥å…· brctl
sudo apt install bridge-utils -y
 # å®‰è£…(user-mode linux)å·¥å…· tunctl
sudo apt install uml-utilities -y
</code></pre></div></div>

<h2 id="é…ç½®ç½‘æ¡¥--qemuè®¾ç½®">é…ç½®ç½‘æ¡¥ &amp; qemuè®¾ç½®</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># &lt;user&gt; å½“å‰useråå­—</span>
<span class="c"># &lt;enp0&gt; éœ€è”ç½‘çš„ç½‘å¡</span>
<span class="c"># &lt;bridge ip&gt; è®¾ç½®ç¬¦åˆä½ å½“å‰ç½‘ç»œç½‘æ®µçš„IPåœ°å€(å¯ä»¥å’Œenp0ç½‘å¡ä¸€æ ·)</span>

<span class="nb">sudo </span>brctl addbr br0
<span class="nb">sudo </span>tunctl <span class="nt">-t</span> tap0 <span class="nt">-u</span> &lt;user&gt; 
<span class="nb">sudo </span>brctl addif br0 tap0 &lt;enp0&gt; 
<span class="nb">sudo </span>ip addr add &lt;bridge ip&gt; dev br0 
<span class="nb">sudo </span>ip <span class="nb">link set</span> &lt;enp0&gt; up
<span class="nb">sudo </span>ip <span class="nb">link set </span>tap0 up
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># è®¾ç½®qemuçš„ç½‘ç»œå‰ç«¯è®¾å¤‡å’Œåç«¯è®¾å¤‡
qemu-system-i386 \ 
-netdev tap,id=net0,ifname=tap0,script=no,downscript=no \
-device e1000,netdev=net0 \
...
</code></pre></div></div>
<h1 id="get-your-hands-dirty">Get your hands dirty</h1>

<h2 id="å¦‚ä½•è®©qemuè™šæ‹Ÿæœºå¯ä»¥è¿æ¥ç½‘ç»œ">å¦‚ä½•è®©qemuè™šæ‹Ÿæœºå¯ä»¥è¿æ¥ç½‘ç»œï¼Ÿ</h2>
<p>è™šæ‹Ÿæœºè¿æ¥ç½‘ç»œéœ€è¦ä¸¤ç§å¿…è¦æ¡ä»¶ï¼Œä¸€ä¸ªæ˜¯ç¡¬ä»¶ï¼Œä¸€ä¸ªæ˜¯è½¯ä»¶ã€‚ç¡¬ä»¶æ˜¯ç½‘å¡ï¼Œè½¯ä»¶å°±æ˜¯ä¸€æ•´å¥—åè®®æ ˆå’Œç½‘å¡é©±åŠ¨ã€‚å½“è™šæ‹Ÿæœºå·²ç»å…·æœ‰æœ€åŸºæœ¬æ¡ä»¶ä¹‹åï¼Œå°±éœ€è¦<strong>å¤–å›´ç½‘ç»œè®¾å¤‡</strong>ä¿éšœç½‘ç»œè¿æ¥ï¼Œqemuæä¾›äº†5ç§ä¸Šç½‘ç­–ç•¥</p>

<ol>
  <li>User Networking (NAT)</li>
  <li><strong>Tap Networking</strong> (Bridge Networking)</li>
  <li>Socket Networking</li>
  <li>Macvtap Networking</li>
  <li>Host Networking</li>
</ol>

<p>æˆ‘é€‰ç”¨äº†ç¬¬äºŒç§ç­–ç•¥ã€‚
<strong>Tap Networking</strong> (Bridge Networking) è¿™ç§è”ç½‘æ–¹å¼æ˜¯é€šè¿‡<code class="language-plaintext highlighter-rouge">tap</code>è®¾å¤‡å°†è™šæ‹Ÿæœºå’Œå®¿ä¸»æœºçš„<strong>ç½‘æ¡¥</strong>ä¸Šï¼Œè™šæ‹Ÿæœºå’Œå®¿ä¸»æœºé€šè¿‡ç½‘æ¡¥è¿æ¥ã€‚è¿™æ ·å®¿ä¸»æœºå¯ä»¥é€šè¿‡ç½‘æ¡¥<strong>è½¬å‘</strong>è™šæ‹Ÿæœºæµé‡ä»è€Œå…±äº«å®¿ä¸»æœºçš„ç½‘å¡ã€‚è¿™ä¸€å¥—å¤–å›´è®¾å¤‡æ˜¯å®¿ä¸»æœºæä¾›çš„ï¼Œè®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥è®¾ç½®ã€‚</p>

<h2 id="å¤–å›´è®¾å¤‡">å¤–å›´è®¾å¤‡</h2>
<p>å…ˆçœ‹ä¸€ä¸‹åˆå§‹ç½‘ç»œæ¥å£ä¿¡æ¯</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip addr show 
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    <span class="nb">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp0s31f6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    <span class="nb">link</span>/ether xx:xx:xx:68:ca:24 brd ff:ff:ff:ff:ff:ff

</code></pre></div></div>
<blockquote>
  <p>å®ä½“ç½‘å¡<strong>enps31f6</strong>å°±æ˜¯å¯ä»¥é“¾æ¥ç½‘ç»œçš„ç½‘å¡ã€‚</p>
</blockquote>

<hr />

<p>æ–°å»ºä¸€ä¸ªç½‘æ¡¥<strong>br0</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>brctl addbr br0
</code></pre></div></div>
<hr />

<p>æ–°å»ºä¸€ä¸ªå«åš<strong>tap0</strong>çš„tapæ¥å£</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>tunctl <span class="nt">-t</span> tap0 <span class="nt">-u</span> &lt;user&gt;
<span class="c"># è®¾ç½®tap0 UP</span>
<span class="nb">sudo </span>ip <span class="nb">link set </span>up dev tap0
</code></pre></div></div>

<blockquote>
  <p>è¿™é‡Œçš„<user>å¡«å†™å…è®¸è®¿é—®è¿™ä¸ªtap0æ¥å£çš„ç”¨æˆ·</user></p>
</blockquote>

<hr />
<p>è¿™æ—¶å€™çš„ç½‘ç»œæ¥å£æƒ…å†µ</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>ip addr show
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    <span class="nb">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp0s31f6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    <span class="nb">link</span>/ether 9c:2d:cd:68:ca:24 brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.14/24 brd 192.168.1.255 scope global dynamic enp0s31f6
       valid_lft 604042sec preferred_lft 604042sec
11: br0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    <span class="nb">link</span>/ether 56:a6:1d:0c:23:17 brd ff:ff:ff:ff:ff:ff
12: tap0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    <span class="nb">link</span>/ether 26:a8:e6:ba:b0:cd brd ff:ff:ff:ff:ff:ff
</code></pre></div></div>
<hr />
<p>æŠŠç½‘å¡å’Œtap0æ¥å£éƒ½æ·»åŠ åˆ°ç½‘æ¡¥ä¸Š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>brctl show
bridge name	bridge <span class="nb">id		</span>STP enabled	interfaces
br0		8000.56a61d0c2317	no
</code></pre></div></div>

<blockquote>
  <p>ç½‘æ¡¥<strong>br0</strong>è¢«æ·»åŠ æ¥å£å‰</p>
</blockquote>

<hr />
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>brctl addif br0 tap0 enp0s31f6
</code></pre></div></div>
<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>brctl show
bridge name	bridge <span class="nb">id		</span>STP enabled	interfaces
br0		8000.56a61d0c2317	no		 enp0s31f6
							         tap0
</code></pre></div></div>
<blockquote>
  <p>ç½‘æ¡¥<strong>br0</strong>è¢«æ·»åŠ æ¥å£å</p>
</blockquote>

<p>æœ¬æ¥è”ç½‘çš„ç½‘å¡<strong>enp0s31f6</strong>å°±ä¸ä¼šåœ¨å¤„ç†æ•°æ®åŒ…äº†ä»–çš„ipåœ°å€ä¹Ÿä¼šä¸è§ï¼Œç°åœ¨çš„ç½‘ç»œæ¥å£ä¿¡æ¯å¦‚ä¸‹</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    <span class="nb">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp0s31f6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master br0 state UP group default qlen 1000
    <span class="nb">link</span>/ether 9c:2d:cd:68:ca:24 brd ff:ff:ff:ff:ff:ff
11: br0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    <span class="nb">link</span>/ether 56:a6:1d:0c:23:17 brd ff:ff:ff:ff:ff:ff
12: tap0: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noop master br0 state DOWN group default qlen 1000
    <span class="nb">link</span>/ether 26:a8:e6:ba:b0:cd brd ff:ff:ff:ff:ff:ff
</code></pre></div></div>

<p>è¿™æ—¶å€™éœ€è¦ç»™ç½‘æ¡¥åˆ†é…ä¸€ä¸ªé€‚åˆä½ ç½‘æ®µçš„ipåœ°å€ï¼Œæˆ–è€…ä½¿ç”¨<code class="language-plaintext highlighter-rouge">sudo dhclient br0</code>ç»™<strong>br0</strong>æä¾›ä¸€ä¸ªipåœ°å€ã€‚
åˆ°è¿™é‡Œå®¿ä¸»æœºçš„å¤–å›´è®¾å¤‡é…ç½®å°±ç»“æŸäº†ã€‚
##qemué…ç½®</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	qemu-system-i386 <span class="se">\</span>
	<span class="nt">-S</span> <span class="se">\</span>
	<span class="nt">-s</span> <span class="se">\</span>
	<span class="nt">-monitor</span> stdio <span class="se">\</span>
	<span class="nt">-m</span> 1G <span class="se">\</span>
	<span class="nt">-hda</span> ubuntu-disk.img <span class="se">\</span>
	<span class="nt">-rtc</span> <span class="nv">base</span><span class="o">=</span>localtime,clock<span class="o">=</span>host <span class="se">\</span>
	<span class="nt">-netdev</span> tap,id<span class="o">=</span>net0,ifname<span class="o">=</span>tap0,script<span class="o">=</span>no,downscript<span class="o">=</span>no <span class="se">\</span>
	<span class="nt">-device</span> e1000,netdev<span class="o">=</span>net0 <span class="se">\</span>
	<span class="nt">-audiodev</span> <span class="nb">id</span><span class="o">=</span>alsa,driver<span class="o">=</span>alsa <span class="se">\</span>
	<span class="nt">-machine</span> pcspk-audiodev<span class="o">=</span>alsa <span class="se">\</span>
	<span class="nt">-cdrom</span> ./ubuntu-14.04.6-server-i386.iso
</code></pre></div></div>
<p>å…³é”®çš„å°±æ˜¯å¯¹ç½‘ç»œè®¾å¤‡çš„é…ç½®ï¼Œ
<code class="language-plaintext highlighter-rouge">-netdev tap,id=net0,ifname=tap0,script=no,downscript=no
 -device e1000,netdev=net0</code>
<code class="language-plaintext highlighter-rouge">-netdev</code>ç”¨äºæŒ‡å®šç½‘ç»œåç«¯å®ç°ï¼Œè¿™é‡Œæ˜¯ç”¨<strong>tap</strong>æ¥å£å®ç°ï¼Œ<strong>ifname</strong>è¿™ä¸ªé€‰é¡¹å¯¹åº”çš„æ¥å£
å°±æ˜¯åˆšåˆšå®¿ä¸»æœºæ–°å»ºçš„tapæ¥å£<strong>tap0</strong>
<code class="language-plaintext highlighter-rouge">-device</code>åˆ™æ˜¯é…ç½®ç½‘å¡
å’Œä½¿ç”¨æŒ‡å®šçš„netdevå®ç°ã€‚</p>

<p>#Troublesh0oting</p>

<ol>
  <li>
    <p>ç½‘æ¡¥é…ç½®å®Œå…¨ä¹‹ååªæœ‰äºŒå±‚åè®®å¯ä»¥é€šè¿‡ä½†æ˜¯ä¸‰å±‚åè®®è¢«ä¸¢åŒ…ï¼Œæ€ä¹ˆè§£å†³ï¼Ÿ 
æœ‰å¯èƒ½æ˜¯ä½ çš„å®¿ä¸»æœºçš„<code class="language-plaintext highlighter-rouge">iptables</code>æ‹¦æˆªäº†æµé‡ï¼ŒæŸ¥çœ‹iptableçš„è§„åˆ™ï¼Œæˆ–è€…ç›´æ¥å…³é—­
 ç½‘æ¡¥è½¬å‘æ•°æ®çš„åŒ…ç»è¿‡iptableså¤„ç†ã€‚æŸ¥çœ‹è¿™ä¸¤ä¸ªæ–‡ä»¶æ˜¯ä¸æ˜¯<code class="language-plaintext highlighter-rouge">1</code>è®¾æˆ<code class="language-plaintext highlighter-rouge">0</code>å…³é—­ã€‚
 <code class="language-plaintext highlighter-rouge">cat /proc/sys/net/bridge/bridge-nf-call-iptables
    cat /proc/sys/net/bridge/bridge-nf-call-ip6tables</code>
 ä½ ä¹Ÿå¯ä»¥ç¼–è¾‘ <code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code> æ·»åŠ </p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> net.bridge.bridge-nf-call-iptables <span class="o">=</span> 1
</code></pre></div>    </div>
    <p><code class="language-plaintext highlighter-rouge">sudo sysctl -p</code>åº”ç”¨ä¿®æ”¹æ¥æ°¸ä¹…ä¿®æ”¹è¿™ä¸ªé…ç½®é¡¹ 
 æˆ–è€…</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">[</span>Unit]
 <span class="nv">Description</span><span class="o">=</span>Setup qemu network bridging
  <span class="nv">After</span><span class="o">=</span>network-online.target
<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>oneshot
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">ExecStart</span><span class="o">=</span>brctl addbr virtbr0
<span class="nv">ExecStart</span><span class="o">=</span>brctl addif virtbr0 enp3s0
<span class="nv">ExecStart</span><span class="o">=</span>ip addr add 192.168.0.20/24 dev virtbr0
<span class="nv">ExecStart</span><span class="o">=</span>ip <span class="nb">link set </span>virtbr0 up
<span class="nv">ExecStart</span><span class="o">=</span>iptables <span class="nt">-I</span> FORWARD <span class="nt">-m</span> physdev <span class="nt">--physdev-is-bridged</span> <span class="nt">-j</span> ACCEPT
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div>    </div>
  </li>
  <li>
    <p>ä½ å¯èƒ½éœ€è¦ç»™tap0å’Œbr0é…ç½®promiscå¯åŠ¨æ··æ‚æ¨¡å¼æ¥ç›‘å¬æµè¿‡ä»–ä»¬çš„æ‰€æœ‰</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="nb">sudo </span>ip <span class="nb">link set </span>promisc on dev tap0
   <span class="nb">sudo </span>ip <span class="nb">link set </span>promisc on dev br
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h2>
<p><a href="https://wiki.qemu.org/Documentation/Networking">1</a> QEMU Networking</p>

<p><a href="https://lifeislife.cn/posts/qemu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/">2</a> QEMU è™šæ‹Ÿæœºç½‘ç»œé…ç½®</p>

<p><a href="https://gist.github.com/extremecoders-re/e8fd8a67a515fee0c873dcafc81d811c">3</a> Setting up Qemu with a tap interface</p>

<p><a href="https://www.spad.uk/posts/really-simple-network-bridging-with-qemu/">4 </a>è¿™é‡Œæåˆ°äº†iptablesè½¬å‘æµé‡çš„è®¾ç½®</p>

<p><a href="https://www.junmajinlong.com/virtual/network/all_about_tun_tap/">æ›´å¤šå…³äºtap/tun</a></p>

<hr />

<h3 id="å">å</h3>
<p>è™½ç„¶è®¾ç½®å¥½è™šæ‹Ÿæœºçš„ç½‘å¡ä½†ä¸€ç›´æ²¡æœ‰å‡ ä¹æ·»åŠ åè®®æ ˆå†…å®¹;*(ï¼Œå¸Œæœ›æœ‰å‡ ä¹å®ç°åè®®æ ˆã€‚</p>

<p>Thu Feb 13 05:37:47 PM CST 2025</p>


</article>

<div class="page-navigation">
	
    <a class="next" href="http://localhost:4000/frog/2024/12/11/on_interrupt.html" title="NEXT: èŠèŠä¸­æ–­">&lt;&lt;</a>
		<span> &middot; </span>
  
		<a class="home" href="http://localhost:4000" title="Back to Homepage">Home</a>
  
		<span> &middot; </span>
    <a class="prev" href="http://localhost:4000/nvim/2024/11/20/history_of_text_editor.html" title="PREV: æ–°é€ çš„è½®å­">&gt;&gt;</a>
  
</div>

		</main>

		<div class="footer">
  <span class="block">ğŸ˜ <a href="/" title="">æ›° æœä¸‰è€Œæš®å›› ä¼—ç‹™çš†æ€’ ç„¶åˆ™æœå››è€Œæš®ä¸‰ ä¼—ç‹™çš†æ‚¦</a> by <a href="http://niclas3.github.io">M</a>.</span>
  <span class="block">&copy; 2025 zhou</span>
</div>


	</body>

</html>
